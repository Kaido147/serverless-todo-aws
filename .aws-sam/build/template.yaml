AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'aws-serverless-todo-workshop Full stack To-Do app with single-table
  DynamoDB design

  '
Globals:
  Function:
    Runtime: python3.13
    Timeout: 30
    Environment:
      Variables:
        TABLE_NAME:
          Ref: TodoTable
Resources:
  TodoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Ref: AWS::StackName
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: PK
        AttributeType: S
      - AttributeName: GSI1PK
        AttributeType: S
      - AttributeName: GSI1SK
        AttributeType: S
      - AttributeName: GSI2PK
        AttributeType: S
      - AttributeName: GSI2SK
        AttributeType: S
      KeySchema:
      - AttributeName: PK
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: GSI1
        KeySchema:
        - AttributeName: GSI1PK
          KeyType: HASH
        - AttributeName: GSI1SK
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: GSI2
        KeySchema:
        - AttributeName: GSI2PK
          KeyType: HASH
        - AttributeName: GSI2SK
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
    Metadata:
      SamResourceId: TodoTable
  TodoApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: '''GET,POST,PUT,DELETE,OPTIONS'''
        AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
        AllowOrigin: '''*'''
    Metadata:
      SamResourceId: TodoApi
  GetTasksFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetTasksFunction
      Handler: get_tasks.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId:
              Ref: TodoApi
            Path: /tasks
            Method: GET
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: TodoTable
    Metadata:
      SamResourceId: GetTasksFunction
  CreateTaskFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CreateTaskFunction
      Handler: create_task.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId:
              Ref: TodoApi
            Path: /tasks
            Method: POST
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TodoTable
    Metadata:
      SamResourceId: CreateTaskFunction
  GetTaskByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetTaskByIdFunction
      Handler: get_task.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId:
              Ref: TodoApi
            Path: /tasks/{id}
            Method: GET
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: TodoTable
    Metadata:
      SamResourceId: GetTaskByIdFunction
  UpdateTaskFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UpdateTaskFunction
      Handler: update_task.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId:
              Ref: TodoApi
            Path: /tasks/{id}
            Method: PUT
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TodoTable
    Metadata:
      SamResourceId: UpdateTaskFunction
  DeleteTaskFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DeleteTaskFunction
      Handler: delete_task.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId:
              Ref: TodoApi
            Path: /tasks/{id}
            Method: DELETE
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TodoTable
    Metadata:
      SamResourceId: DeleteTaskFunction
  GetCategoriesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetCategoriesFunction
      Handler: get_categories.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId:
              Ref: TodoApi
            Path: /categories
            Method: GET
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: TodoTable
    Metadata:
      SamResourceId: GetCategoriesFunction
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AWS::StackName}-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    Metadata:
      SamResourceId: WebsiteBucket
  WebsiteOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name:
          Fn::Sub: ${AWS::StackName}-oac
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4
    Metadata:
      SamResourceId: WebsiteOAC
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: WebsiteBucket
      PolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: cloudfront.amazonaws.com
          Action: s3:GetObject
          Resource:
            Fn::Sub: ${WebsiteBucket.Arn}/*
          Condition:
            StringEquals:
              AWS:SourceArn:
                Fn::Sub: arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}
    Metadata:
      SamResourceId: WebsiteBucketPolicy
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
        - Id: S3Origin
          DomainName:
            Fn::GetAtt:
            - WebsiteBucket
            - RegionalDomainName
          OriginAccessControlId:
            Ref: WebsiteOAC
          S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
          - GET
          - HEAD
          CachedMethods:
          - GET
          - HEAD
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
        CustomErrorResponses:
        - ErrorCode: 404
          ResponseCode: 200
          ResponsePagePath: /index.html
        PriceClass: PriceClass_100
    Metadata:
      SamResourceId: CloudFrontDistribution
Outputs:
  ApiUrl:
    Description: API Gateway URL
    Value:
      Fn::Sub: https://${TodoApi}.execute-api.${AWS::Region}.amazonaws.com/prod/
  TableName:
    Description: DynamoDB table name
    Value:
      Ref: TodoTable
  CloudFrontUrl:
    Description: CloudFront URL
    Value:
      Fn::Sub: https://${CloudFrontDistribution.DomainName}
  WebsiteBucketName:
    Description: S3 bucket for frontend files
    Value:
      Ref: WebsiteBucket
